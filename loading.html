<!DOCTYPE HTML>
<html>
<head>

	<title>Tip4Tip</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Header -->
		<header id="header">
			<div class="inner">

				<!-- Logo -->
				<a href="generic.html" class="logo">
					<span class="symbol"></span><span class="title">< back</span>
				</a>
			</div>
		</header>


		<!-- Main -->
		<div id="main">
			<div class="inner">
				<h1>Hold on, sit tight!</h1>
				<div>
					<h2> Connecting you in: </h2>
					<h2 id="clock"></h2>

					<div class="alert alert-success" id="success-alert">
					    <strong>Connected! </strong>
					    You'll be brought to the chat page in a few seconds.
					</div>

					<p id="notificationAlert">Want a phone or email notification once you're connected?
						Leave your info below!</p>
            <p id="notificationAlertBelow"></p>
						<div class="button-container">
							<button type="button" id="getAText" class="ourButton" data-toggle="modal"
							data-target="#infoModal">Get a Text!</button>

							<div id="infoModal" class="modal fade" role="dialog">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<h4 class="modal-title">Get a Text!</h4>
										</div>
										<div class="modal-body">
											<form>

												<div class="form-group">
													<label for="phoneInput">Phone number:</label>
													<input type="tel" class="form-control" id="phoneInput" placeholder="123-456-7890">
												</div>
												<div>
													<button id="submitPhone" type="button" class="ourButton" data-toggle="modal"
													data-target="#myModal" id="submitButton">Submit</button>

													<div id="myModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-header">
																	<h4 class="modal-title">Alert Set!</h4>
																</div>
																<div class="modal-body">
																	<p id="phoneSubmitText">Thanks for submitting your phone!
																		We'll notify you once you're connected with a tipster, so grab a cup of coffee while you wait!</p>
																	</div>
																	<div class="modal-footer">
																		<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</form>
											</div>
										</div>
									</div>
								</div>

							</div>

							<div class="button-container">
								<button type="button" class="ourButton" data-toggle="modal"
								data-target="#info1Modal" id="getAnEmail">Get an Email!</button>
								<div id="info1Modal" class="modal fade" role="dialog">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h4 class="modal-title">Get an Email!</h4>
												</div>
												<div class="modal-body">
													<form>
														<div class="form-group">
															<label for="emailInput">Email address:</label>
															<input id="#emailAdd" type="email" class="form-control" id="emailInput">
														</div>

														<div>
														<button id="submitEmail" type="button" class="ourButton" data-toggle="modal"
															data-target="#myModal1" id="submitButton">Submit</button>
															<div id="myModal1" class="modal fade" role="dialog">
																<div class="modal-dialog">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h4 class="modal-title">Alert Set!</h4>
																		</div>
																		<div class="modal-body">
																			<p>Thanks for submitting your email!
																				We'll notify you once you're connected with a tipster, so grab a cup of coffee while you wait!</p>
																			</div>
																			<div class="modal-footer">
																				<button type="button" class="btn btn-defaul" data-dismiss="modal">Close</button>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
														</form>
													</div>
												</div>
											</div>
										</div>

									</div>
								</div>
							</div>
						</div>


						<!-- Footer -->

					</div>

					<!-- Scripts -->
					<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
					<link rel="stylesheet" href="assets/css/main.css" />
					<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
					<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>



					<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.0/jquery.fancybox.min.js"></script>
					<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.0/jquery.fancybox.min.css">

          <script src="https://apis.google.com/js/api.js"></script>
          <script>
          //  function start() {
          //    // Initializes the client with the API key and the Translate API.
          //    gapi.client.init({
          //      'apiKey': 'YOUR_API_KEY',
          //      'discoveryDocs': ['https://www.googleapis.com/discovery/v1/apis/translate/v2/rest'],
          //    }).then(function() {
          //      // Executes an API request, and returns a Promise.
          //      // The method name `language.translations.list` comes from the API discovery.
          //      return gapi.client.language.translations.list({
          //        q: 'hello world',
          //        source: 'en',
          //        target: 'de',
          //      });
          //    }).then(function(response) {
          //      console.log(response.result.data.translations[0].translatedText);
          //    }, function(reason) {
          //      console.log('Error: ' + reason.result.error.message);
          //    });
          //  };

          //  // Loads the JavaScript client library and invokes `start` afterwards.
          //  gapi.load('client', start);
          //</script>
          <script>
          //  $("#submitEmail").click( function() {
          //    var emailAdd = $("#emailAdd").val();
          //    var values = [ [emailAdd], ];
          //    var body = {
          //      values: values
          //    };
          //    gapi.client.sheets.spreadsheets.values.update({
          //       spreadsheetId: "16CjJA-TxUufuKemTseJkfIH3QV2dduvG5qCwQIc1Ays",
          //       range: "Sheet1!A5:A6",
          //       valueInputOption: valueInputOption,
          //       resource: body
          //    }).then((response) => {
          //      var result = response.result;
          //      console.log(`${result.updatedCells} cells updated.`);
          //    });

          //  )};
          </script>
          <script src="xml2json.js"></script>
          <script>
          $("#phoneInput").keypress(function(e) {
              if(e.which == 13) {
                  e.preventDefault();
                  $("#submitPhone").click();
                }
              });
          </script>
          <script>
            console.log("adding a click function to get text");
            $("#submitPhone").click( function() {
              var phoneNum = $("#phoneInput").val();
              if(phoneNum){
                phoneNum = phoneNum.replace(/\D/g,'');
                phoneNum = "+1" + phoneNum;
                console.log(phoneNum);
                var SID = "AC69c32981bb0a6e32e29a940cd4683559";
                var Key = "d3d5e6f4d73c46af8cf111085ea3c34b";

                $.ajax({
                    type: 'POST',
                    url: 'https://api.twilio.com/2010-04-01/Accounts/' + SID + '/Messages.json',
                    data: {
                        "To" : phoneNum,
                        "From" : "+14159699409",
                        "Body" : "\nHello, your Tipster is waiting for you" +
                        "at https://joannegaeunson.github.io/Tip4TipFinal/chat.html.\n\nDo not reply to this message."
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader ("Authorization", "Basic " + btoa(SID + ':' + Key));
                    },
                    success: function(data) {
                        console.log(data);
                        $("#getAText").text("Send to Another Number");
                        $("#phoneSubmitText").text("You will recieve a text with" +
                            " a url when a tipster is ready for you. You may exit" +
                            " the app now.");
                        $("#notificationAlertBelow").text("Subscribed to text " +
                            "notifications with the number: " + phoneNum);
                    },

                    error: function(data) {
                      console.log(data);
                      $("#phoneSubmitText").text("Your phone number is not yet" +
                          "verified. You will recieve a call to verify it." +
                          "You only need to verify once.");
                      $.ajax({
                        type: 'POST',
                        url: 'https://api.twilio.com/2010-04-01/Accounts/' +
                          SID + '/OutgoingCallerIds',
                        
                        data: {
                          'PhoneNumber' : phoneNum,
                        },
                        beforeSend: function (xhr) {
                          xhr.setRequestHeader ("Authorization", "Basic " + btoa(SID + ':' + Key));
                        },
                        success: function(data) {
                          console.log(data);
                          json = $.xml2json(data);
                          console.log(json);
                          var code = (json['#document']['TwilioResponse']['ValidationRequest']['ValidationCode']);
                          $("#phoneSubmitText").text("Your phone number is not yet" +
                        " verified. You will recieve a call to verify it." +
                        " You only need to verify once. Your verification code" + 
                        " is: " +  code );
                        $("#notificationAlertBelow").text("You should have" +
                          " recieved a call. After you validate, click 'Get a" +
                          " text' to enable notifications. Once again your validation number" +
                          " is " + code );
                        },
                        error: function(data) {
                          $("#phoneSubmitText").text("The phone number your" +
                              "provided is not valid");
                        }
                        });
                    }
                });
              }
            });
          </script>

          			<script>
						$("#success-alert").hide();
						var time_in_minutes = 2;
						var current_time = Date.parse(new Date());
						var deadline = new Date(current_time + time_in_minutes*60*1000);

						function time_remaining(endtime){
							var t = Date.parse(endtime) - Date.parse(new Date());
							var seconds = Math.floor( (t/1000) % 60 );
							var minutes = Math.floor( (t/1000/60) % 60 );
							var hours = Math.floor( (t/(1000*60*60)) % 24 );
							var days = Math.floor( t/(1000*60*60*24) );
							return {'total':t, 'days':days, 'hours':hours, 'minutes':minutes, 'seconds':seconds};
						}

						function run_clock(id,endtime){
							var clock = document.getElementById(id);
							function update_clock(){
								var t = time_remaining(endtime);
								clock.innerHTML = t.minutes + ' minute(s) & ' + t.seconds + " seconds";
								if(t.total<=0){ 
									$("#success-alert").show();
									$("#clock").remove()
									$("#notificationAlert").remove()
									$("#getAText").remove()
									$("#getAnEmail").remove()
									setTimeout(function() { window.location = "chat.html"}, 5000);   
									clearInterval(timeinterval); 

								}
							}
							update_clock(); // run function once at first to avoid delay
							var timeinterval = setInterval(update_clock,1000);
						}
						run_clock('clock',deadline);

					</script>

				</body>
				</html>
